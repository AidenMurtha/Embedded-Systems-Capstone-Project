#include <WiFi.h>
#include <HTTPClient.h>

// ===== Wi-Fi credentials =====
const char* ssid     = "TaterTot";
const char* password = "AMBHSP003004!";

// ===== Google Apps Script Web App URL =====
const char* scriptURL = "https://script.google.com/macros/s/AKfycbyPHmRlMgO5JB6sLPCsCE6HTcCwijIZd26-lILoutbVRfCFrLsDankxUmlznjzmnl95/exec";

// MUST match the Apps Script token
const char* token = "esp_secure_token_123";

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\nESP32 Data Upload Test");

  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(400);
    Serial.print(".");
  }

  Serial.println("\nConnected!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
}


// ============================================================
// Upload test data for a device
// ============================================================
void sendDataToGoogle(String deviceID) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi lost, reconnecting...");
    WiFi.reconnect();
    return;
  }

  // Fake test values
  float voltage = 11.8 + random(-10, 10) * 0.01;
  float current = 1.00 + random(-10, 10) * 0.01;

  HTTPClient http;
  http.begin(scriptURL);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  // Build POST payload
  String postData =
    "token=" + String(token) +
    "&device=" + deviceID +
    "&voltage=" + String(voltage, 2) +
    "&current=" + String(current, 2);

  Serial.println("\n[POST] Sending:");
  Serial.println(postData);

  int httpCode = http.POST(postData);

  if (httpCode > 0) {
    Serial.printf("[HTTP %d] %s\n", httpCode, http.getString().c_str());
  } else {
    Serial.printf("POST failed: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}


// ============================================================
// MAIN LOOP
// Sends Device A then Device B every 5 seconds
// ============================================================
void loop() {
  sendDataToGoogle("A");
  delay(5000);

  sendDataToGoogle("B");
  delay(5000);
}
