#include <ps5Controller.h>
#include <WiFi.h>
#include <HTTPClient.h>

// ----------------------------------------------------------
// UART SETUP (ESP32 → Nano)
// ----------------------------------------------------------
HardwareSerial NanoSerial(2);  // UART2 (RX=16, TX=17)
#define TX_PIN 17
#define RX_PIN 16

// ----------------------------------------------------------
// RELAY COMMANDS
// ----------------------------------------------------------
#define RELAY_ON_CMD  "ON\n"
#define RELAY_OFF_CMD "OFF\n"

// ----------------------------------------------------------
// WIFI + GOOGLE SHEETS CONFIG
// ----------------------------------------------------------
const char* ssid     = "TTUguest";
const char* password = "maskedraiders";

const char* scriptURL = "https://script.google.com/macros/s/AKfycbw6wzPuwdyfRcvRqjWybFhQxsNA5XX-iDjRCSaPl17rx9U2byBzeG3bX6Js6A9FHZXZTQ/exec";
const char* token = "esp_secure_token_123";

// ----------------------------------------------------------
// SETUP
// ----------------------------------------------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  Serial.println("\n=== MERGED ESP32 SYSTEM ===");
  Serial.println("Setting up UART2 for Nano communication...");
  NanoSerial.begin(115200, SERIAL_8N1, RX_PIN, TX_PIN);
  Serial.println("UART2 Ready.");

  // ------------------------------------------------------
  // PS5 Controller Setup
  // ------------------------------------------------------
  ps5.attachOnConnect([]() { Serial.println("[PS5] Connected!"); });
  ps5.attachOnDisconnect([]() { Serial.println("[PS5] Disconnected!"); });

  const char* ps5MAC = "90:b6:85:16:55:b1";
  Serial.println("Connecting to PS5 Controller...");
  ps5.begin(ps5MAC);

  // ------------------------------------------------------
  // WiFi Setup
  // ------------------------------------------------------
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(400);
    Serial.print(".");
  }

  Serial.println("\nWiFi Connected!");
  Serial.print("Device IP: ");
  Serial.println(WiFi.localIP());
}

// ----------------------------------------------------------
// SEND TO GOOGLE SHEETS FUNCTION
// ----------------------------------------------------------
void sendToGoogle(String deviceID, float voltage, float current, float power) {

  Serial.println("\n--- Preparing Upload ---");
  Serial.printf("Device: %s\n", deviceID.c_str());
  Serial.printf("Voltage: %.2f V\n", voltage);
  Serial.printf("Current: %.2f mA\n", current);
  Serial.printf("Power:   %.2f mW\n", power);

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("ERROR: WiFi lost, attempting reconnect...");
    WiFi.reconnect();
    return;
  }

  HTTPClient http;
  http.begin(scriptURL);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  String postData =
      "token=" + String(token) +
      "&device=" + deviceID +
      "&voltage=" + String(voltage, 2) +
      "&current=" + String(current, 2) +
      "&power=" + String(power, 2);

  Serial.println("POST DATA:");
  Serial.println(postData);

  int httpCode = http.POST(postData);

  if (httpCode > 0) {
    Serial.printf("HTTP %d RESPONSE:\n", httpCode);
    Serial.println(http.getString());
  } else {
    Serial.printf("POST FAILED: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}

// ----------------------------------------------------------
// MAIN LOOP
// ----------------------------------------------------------
void loop() {

  // =======================================================
  // 1. PS5 CONTROLLER LOGIC — relay control
  // =======================================================
  if (ps5.isConnected()) {

    if (ps5.Cross()) {
      Serial.println("[PS5] Relay ON");
      NanoSerial.print(RELAY_ON_CMD);
      delay(200);
    }

    if (ps5.Circle()) {
      Serial.println("[PS5] Relay OFF");
      NanoSerial.print(RELAY_OFF_CMD);
      delay(200);
    }
  }

  // =======================================================
  // 2. SENSOR DATA FROM NANO (CSV LINE)
  // =======================================================
  if (!NanoSerial.available()) return;

  String line = NanoSerial.readStringUntil('\n');
  line.trim();

  if (line.length() == 0) return;

  Serial.println("\n===============================");
  Serial.print("RAW UART DATA RECEIVED: ");
  Serial.println(line);

  // Expect format: V1,I1,P1,V2,I2,P2
  int c1 = line.indexOf(',');
  int c2 = line.indexOf(',', c1 + 1);
  int c3 = line.indexOf(',', c2 + 1);
  int c4 = line.indexOf(',', c3 + 1);
  int c5 = line.indexOf(',', c4 + 1);

  if (c1 < 0 || c2 < 0 || c3 < 0 || c4 < 0 || c5 < 0) {
    Serial.println("ERROR: CSV format incorrect. Expected 6 comma-separated values.");
    return;
  }

  float V1 = line.substring(0,      c1).toFloat();
  float I1 = line.substring(c1 + 1, c2).toFloat();
  float P1 = line.substring(c2 + 1, c3).toFloat();

  float V2 = line.substring(c3 + 1, c4).toFloat();
  float I2 = line.substring(c4 + 1, c5).toFloat();
  float P2 = line.substring(c5 + 1).toFloat();

  Serial.println("\n--- PARSED SENSOR VALUES ---");
  Serial.printf("INA1 → Voltage: %.2f V   Current: %.2f mA   Power: %.2f mW\n", V1, I1, P1);
  Serial.printf("INA2 → Voltage: %.2f V   Current: %.2f mA   Power: %.2f mW\n", V2, I2, P2);

  Serial.println("\nSending data to Google Sheets...");

  sendToGoogle("A", V1, I1, P1);
  sendToGoogle("B", V2, I2, P2);

  Serial.println("UPLOAD COMPLETE.");
  Serial.println("===============================\n");
}
