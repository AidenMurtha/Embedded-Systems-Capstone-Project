#include <WiFi.h>
#include <HTTPClient.h>

HardwareSerial NanoSerial(2);  // UART2 (RX=16, TX=17)

// ===== Wi-Fi credentials =====
const char* ssid     = "TTUguest";
const char* password = "maskedraiders";

// ===== Google Apps Script Web App URL =====
const char* scriptURL = "https://script.google.com/macros/s/AKfycbw6wzPuwdyfRcvRqjWybFhQxsNA5XX-iDjRCSaPl17rx9U2byBzeG3bX6Js6A9FHZXZTQ/exec";

// MUST match the Apps Script token
const char* token = "esp_secure_token_123";


// ============================================================
// WiFi setup
// ============================================================
void setup() {
  Serial.begin(115200);
  delay(500);

  // DEBUG
  Serial.println("\n=== ESP32 POWER MONITOR DEBUG MODE ===");
  Serial.println("Setting up UART2 for Nano communication...");

  NanoSerial.begin(115200, SERIAL_8N1, 16, 17);

  Serial.println("UART2 Ready (Nano → ESP32)");

  // WiFi
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(400);
    Serial.print(".");
  }

  Serial.println("\nWiFi Connected!");
  Serial.print("Device IP: ");
  Serial.println(WiFi.localIP());
}


// ============================================================
// Send device data to Google Sheets
// ============================================================
void sendToGoogle(String deviceID, float voltage, float current, float power) {

  // DEBUG
  Serial.println("\n--- Preparing Upload ---");
  Serial.printf("Device: %s\n", deviceID.c_str());
  Serial.printf("Voltage: %.2f V\n", voltage);
  Serial.printf("Current: %.2f mA\n", current);
  Serial.printf("Power:   %.2f mW\n", power);

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("ERROR: WiFi lost, attempting reconnect...");
    WiFi.reconnect();
    return;
  }

  HTTPClient http;
  http.begin(scriptURL);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  String postData =
      "token=" + String(token) +
      "&device=" + deviceID +
      "&voltage=" + String(voltage, 2) +
      "&current=" + String(current, 2) +
      "&power=" + String(power, 2);

  // DEBUG
  Serial.println("POST DATA:");
  Serial.println(postData);

  int httpCode = http.POST(postData);

  if (httpCode > 0) {
    Serial.printf("HTTP %d RESPONSE:\n", httpCode);
    Serial.println(http.getString());
  } else {
    Serial.printf("POST FAILED: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}


// ============================================================
// MAIN LOOP — parse Nano data + upload
// ============================================================
void loop() {

  if (!NanoSerial.available()) return;

  // Read entire CSV line
  String line = NanoSerial.readStringUntil('\n');
  line.trim();

  if (line.length() == 0) return;

  // DEBUG
  Serial.println("\n===============================");
  Serial.print("RAW UART DATA RECEIVED: ");
  Serial.println(line);

  // Expect: V1,I1,P1,V2,I2,P2
  int c1 = line.indexOf(',');
  int c2 = line.indexOf(',', c1 + 1);
  int c3 = line.indexOf(',', c2 + 1);
  int c4 = line.indexOf(',', c3 + 1);
  int c5 = line.indexOf(',', c4 + 1);

  if (c1 < 0 || c2 < 0 || c3 < 0 || c4 < 0 || c5 < 0) {
    Serial.println("ERROR: CSV format incorrect. Expected 6 comma-separated values.");
    Serial.println("Format must be: V1,I1,P1,V2,I2,P2");
    return;
  }

  // DEBUG — show split indexes
  Serial.println("Comma positions:");
  Serial.printf("c1=%d  c2=%d  c3=%d  c4=%d  c5=%d\n", c1, c2, c3, c4, c5);

  // Convert from string to float
  float V1 = line.substring(0,      c1).toFloat();
  float I1 = line.substring(c1 + 1, c2).toFloat();
  float P1 = line.substring(c2 + 1, c3).toFloat();

  float V2 = line.substring(c3 + 1, c4).toFloat();
  float I2 = line.substring(c4 + 1, c5).toFloat();
  float P2 = line.substring(c5 + 1).toFloat();

  // DEBUG — parsed values
  Serial.println("\n--- PARSED SENSOR VALUES ---");
  Serial.printf("INA1 → Voltage: %.2f V   Current: %.2f mA   Power: %.2f mW\n", V1, I1, P1);
  Serial.printf("INA2 → Voltage: %.2f V   Current: %.2f mA   Power: %.2f mW\n", V2, I2, P2);

  // Debug line to ensure we wait between packets
  Serial.println("\nSending data to Google Sheets...");

  // SEND TO GOOGLE SHEETS
  sendToGoogle("A", V1, I1, P1);
  sendToGoogle("B", V2, I2, P2);

  Serial.println("UPLOAD COMPLETE.");
  Serial.println("===============================\n");
}
